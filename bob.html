<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘è¦çœ‹ç”µè§†å‰§äº†ï¼Œä¸æƒ³è¯´è¯äº†ã€‚</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #222; color: #eee; padding: 20px; max-width: 600px; margin: 0 auto; }
        h2 { text-align: center; color: #ff99cc; margin-bottom: 10px; font-size: 1.5em; }
        .card { background: #333; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin-bottom: 20px; }
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9em; color: #aaa; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #555; background: #444; color: white; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        textarea { height: 100px; resize: vertical; }
        button { width: 100%; padding: 15px; background-color: #cc6699; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: background 0.2s; }
        button.secondary { background-color: #555; font-size: 14px; margin-top: 10px; padding: 10px; }
        button:active { opacity: 0.8; transform: scale(0.98); }
        button:disabled { background-color: #777; cursor: not-allowed; }
        #audio-player { width: 100%; margin-top: 20px; }
        .details { display: none; margin-top: 15px; border-top: 1px solid #555; padding-top: 10px; }
        .toggle-btn { background: none; color: #888; border: none; font-size: 14px; padding: 5px; margin: 0 auto; display: block; cursor: pointer;}
        .status { text-align: center; margin-top: 10px; font-size: 14px; color: #bbb; min-height: 20px; }
        .model-group { border-left: 3px solid #cc6699; margin-top: 15px; background: #2a2a2a; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <h2>æˆ‘è¦çœ‹ç”µè§†å‰§äº†ï¼Œä¸æƒ³è¯´è¯äº†ã€‚ <span style="font-size:0.6em; color:#ffff00">ğŸ”’Pro</span></h2>

    <div class="card">
        <label>è¾“å…¥æ–‡å­— (Text):</label>
        <textarea id="text_input">æˆ‘å—“å­å¼€å§‹æœ‰ç‚¹ç–¼äº†</textarea>
        
        <button id="send_btn" onclick="generateAudio()">ç”Ÿæˆè¯­éŸ³</button>
        <div class="status" id="status"></div>
        <audio id="audio-player" controls style="display:none;"></audio>
    </div>

    <button class="toggle-btn" onclick="toggleSettings('settings-panel')">âš™ï¸ è®¾ç½® (Settings)</button>

    <div class="card details" id="settings-panel">
        <label style="color:#ff99cc">API åœ°å€ (Ngrok URL):</label>
        <input type="text" id="api_url" value="https://madison-unmotored-oracularly.ngrok-free.dev">
        <small style="color:#777">å¡«å…¥ Ngrok åœ°å€ï¼Œä¸è¦å¸¦ /tts</small>

        <label style="color:#ffff00">è®¿é—®å¯†ç  (API Password):</label>
        <input type="password" id="api_key" value="0703">

        <label>ç”µè„‘å±€åŸŸç½‘ IP (ç”¨äºæ¨¡å‹åˆ‡æ¢):</label>
        <input type="text" id="host_ip" value="172.20.10.6">

        <label>å‚è€ƒéŸ³é¢‘è·¯å¾„:</label>
        <input type="text" id="ref_audio_path" value="boyang_ref.wav">
        
        <div style="display: flex; gap: 10px;">
            <div style="flex:1">
                <label>å‚è€ƒè¯­ç§:</label>
                <select id="prompt_lang">
                    <option value="zh" selected>ä¸­æ–‡</option>
                    <option value="ja" >æ—¥è¯­</option>
                    <option value="en">è‹±è¯­</option>
                </select>
            </div>
            <div style="flex:1">
                <label>ç›®æ ‡è¯­ç§:</label>
                <select id="text_lang">
                    <option value="zh">ä¸­æ–‡</option>
                    <option value="ja">æ—¥è¯­</option>
                    <option value="auto" selected>è‡ªåŠ¨</option>
                </select>
            </div>
        </div>

        <label>å‚è€ƒæ–‡æœ¬ (Ref Text):</label>
        <input type="text" id="prompt_text" value="ä¸çŸ¥ä»ä»€ä¹ˆåœ°æ–¹è·‘å‡ºä¸€ä¸ªäººï¼Œåœ¨æˆ‘èƒŒåæ‰“äº†ä¸€æ‹³ã€‚">

        <div style="display: flex; gap: 10px;">
            <div style="flex:1"><label>Top K:</label><input type="number" id="top_k" value="10"></div>
            <div style="flex:1"><label>Temp:</label><input type="number" id="temperature" value="0.85"></div>
            <div style="flex:1"><label>Speed:</label><input type="number" id="speed" value="0.85"></div>
        </div>

        <button class="toggle-btn" onclick="toggleSettings('model-panel')" style="margin-top:20px">ğŸ”„ åˆ‡æ¢æ¨¡å‹ (Model Switch)</button>
        <div id="model-panel" class="details" style="display:none">
            <div class="model-group">
                <label>GPT æ¨¡å‹è·¯å¾„ (.ckpt):</label>
                <input type="text" id="gpt_path" value="D:\gpt-sov\GPT-SoVITS-v2pro-20250604\GPT_weights_v2Pro\Boyang2-e50.ckpt">
                <button class="secondary" onclick="switchModel('gpt')">åˆ‡æ¢ GPT</button>
            </div>
            <div class="model-group">
                <label>SoVITS æ¨¡å‹è·¯å¾„ (.pth):</label>
                <input type="text" id="sovits_path" value="D:\gpt-sov\GPT-SoVITS-v2pro-20250604\SoVITS_weights_v2Pro\Boyang2_e8_s112.pth">
                <button class="secondary" onclick="switchModel('sovits')">åˆ‡æ¢ SoVITS</button>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–ï¼šä¼˜å…ˆè¯»å–ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨HTMLä¸­çš„é»˜è®¤å€¼
        window.onload = function() {
            const fields = ['api_url', 'api_key', 'host_ip', 'ref_audio_path', 'prompt_text', 'prompt_lang', 'text_lang', 'top_k', 'temperature', 'speed', 'gpt_path', 'sovits_path'];
            fields.forEach(id => {
                const saved = localStorage.getItem(id);
                if (saved) document.getElementById(id).value = saved;
            });
        };

        function toggleSettings(id) {
            const panel = document.getElementById(id);
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        function saveConfig() {
            const fields = ['api_url', 'api_key', 'host_ip', 'ref_audio_path', 'prompt_text', 'prompt_lang', 'text_lang', 'top_k', 'temperature', 'speed', 'gpt_path', 'sovits_path'];
            fields.forEach(id => {
                const val = document.getElementById(id).value;
                if(val) localStorage.setItem(id, val);
            });
        }

        async function switchModel(type) {
            saveConfig();
            const host = document.getElementById('host_ip').value; 
            const status = document.getElementById('status');
            const path = document.getElementById(type + '_path').value;
            
            if (!path) return alert("è¯·å…ˆå¡«å†™æ¨¡å‹è·¯å¾„ï¼");

            const endpoint = type === 'gpt' ? 'set_gpt_weights' : 'set_sovits_weights';
            const url = `http://${host}:9880/${endpoint}?weights_path=${encodeURIComponent(path)}`;

            status.innerText = `æ­£åœ¨åˆ‡æ¢ ${type} ...`;

            try {
                const res = await fetch(url);
                if(res.ok) {
                    status.innerText = "åˆ‡æ¢æˆåŠŸï¼";
                    alert(`${type.toUpperCase()} æ¨¡å‹åˆ‡æ¢æˆåŠŸï¼`);
                } else {
                    throw new Error("APIè¿”å›é”™è¯¯");
                }
            } catch(e) {
                status.innerText = "åˆ‡æ¢å¤±è´¥";
                alert("åˆ‡æ¢å¤±è´¥ï¼šè¯·æ£€æŸ¥ç”µè„‘IPæ˜¯å¦æ­£ç¡®ï¼Œæˆ–APIçª—å£æ˜¯å¦æœ‰æŠ¥é”™ã€‚");
            }
        }

        async function generateAudio() {
            saveConfig();
            const btn = document.getElementById('send_btn');
            const status = document.getElementById('status');
            const player = document.getElementById('audio-player');
            const text = document.getElementById('text_input').value;
            const apiKey = document.getElementById('api_key').value;
            
            let baseUrl = document.getElementById('api_url').value.replace(/\/$/, ""); 

            if (!text || !baseUrl) return alert("è¯·å¡«å†™æ–‡æœ¬å’Œ API åœ°å€ (Ngrok)ï¼");

            const url = `${baseUrl}/tts`;

            const payload = {
                "text": text,
                "text_lang": document.getElementById('text_lang').value,
                "ref_audio_path": document.getElementById('ref_audio_path').value,
                "prompt_text": document.getElementById('prompt_text').value,
                "prompt_lang": document.getElementById('prompt_lang').value,
                "top_k": parseInt(document.getElementById('top_k').value),
                "temperature": parseFloat(document.getElementById('temperature').value),
                "speed_factor": parseFloat(document.getElementById('speed').value),
                "media_type": "wav",
                "streaming_mode": false
            };

            btn.disabled = true;
            btn.innerText = "ç”Ÿæˆä¸­...";
            status.innerText = "ç©¿é€ä¸­...";
            player.style.display = 'none';

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        // ã€å…³é”®ä¿®æ­£ã€‘è¿™é‡Œä¸å†ç”¨ Basic Authï¼Œè€Œæ˜¯ç”¨ X-Password
                        "X-Password": apiKey,
                        "ngrok-skip-browser-warning": "true"
                    },
                    body: JSON.stringify(payload)
                });

                if (response.status === 401) throw new Error("å¯†ç é”™è¯¯ (æš—å·ä¸å¯¹)");
                if (!response.ok) throw new Error("API Error: " + response.statusText);

                const blob = await response.blob();
                const audioUrl = URL.createObjectURL(blob);
                
                player.src = audioUrl;
                player.style.display = 'block';
                player.play();
                status.innerText = "ç”ŸæˆæˆåŠŸ";
            } catch (error) {
                alert("å¤±è´¥ï¼š" + error.message);
                status.innerText = "è¿æ¥å¤±è´¥";
            } finally {
                btn.disabled = false;
                btn.innerText = "ç”Ÿæˆè¯­éŸ³";
            }
        }
    </script>
</body>
</html>